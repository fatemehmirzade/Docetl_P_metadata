default_model: gpt-4o
max_threads: 4

optimizer_config:
  enable_optimizer: true
  sample_size: 5  
  validation_sample_size: 3  
  optimizer_model: gpt-4o

datasets:
  papers:
    type: file
    path: ./papers_dataset.json

operations:
  - name: extract_clinical_info
    type: map
    model: gpt-4o
    output:
      schema:
        Disease: list[string]
        DiseaseTreatment: list[string]
        CellLine: list[string]
        CellType: list[string]
        CellPart: list[string]
        Treatment: list[string]
        SampleTreatment: list[string]
        Staining: list[string]
        GrowthRate: list[string]
        SamplingTime: list[string]
        BMI: list[string]
        AnatomicSiteTumor: list[string]
        OriginSiteDisease: list[string]
        TumorCellularity: list[string]
        TumorGrade: list[string]
        TumorStage: list[string]
        TumorSize: list[string]
        TumorSite: list[string]
        FactorValue: list[string]
    prompt: |
      You are extracting clinical and experimental context metadata from proteomics research papers to enable standardized data cataloging, biological interpretation, and sample comparability across studies. Your task is to carefully read the provided text and identify all explicitly mentioned clinical or experimental details across 19 categories. This information is critical for researchers to understand disease context (for clinical studies), experimental models and perturbations (for laboratory studies), and to assess the biological relevance and translatability of proteomics findings. Papers may contain CLINICAL data (patient samples, tumor characteristics), LABORATORY data (cell cultures, animal models, experimental treatments), or both - adapt your extraction accordingly.
      
      Paper: {{ input.filename }}
      {% if input.methods %}
      Methods section:
      """{{ input.methods }}"""
      {% endif %}
      {% if input.supplementary_information %}
      Supplementary information:
      """{{ input.supplementary_information }}"""
      {% endif %}
      
      Extract ALL mentions of the following categories and IMMEDIATELY STANDARDIZE them as indicated. ONLY extract information that is explicitly stated in the text - do not infer, assume, or generate any information:
      
      - Disease: disease names in standardized "Full Name (ABBR)" format (e.g., "Alzheimer's disease (AD)", "breast cancer", "colorectal cancer (CRC)", "lung squamous cell carcinoma (LSCC)", "type 2 diabetes", "malaria")
      - DiseaseTreatment: medical treatments for diseases (e.g., "chemotherapy", "immunotherapy", "radiation therapy", "pembrolizumab", "cisplatin treatment")
      - CellLine: cell line names in standard format (e.g., "HeLa", "HEK293", "MCF-7", "A549", "Jurkat", "K562", "U2-OS")
        
        **CRITICAL**: CellLine is for IMMORTALIZED CELL LINES only (e.g., "HeLa", "HEK293")
        - DO NOT extract strain designations here (e.g., "P. falciparum strain 3D7" goes to Strain, not CellLine)
      
      - CellType: cell type names - CRITICAL: ALWAYS CONVERT immunological markers to full cell type names:
        * "CD8+" → "CD8+ T cells"
        * "CD4+" → "CD4+ T cells"
        * "FOXP3+" → "regulatory T cells (Tregs)"
        * "CD20+" or "CD19+" → "B cells"
        * "CD33+" → "myeloid cells"
        * "CD11c+" → "dendritic cells"
        * "CD11b+" → "myeloid cells"
        * Also capture: "neurons", "hepatocytes", "fibroblasts", "macrophages", "endothelial cells", "erythrocytes"
      - CellPart: subcellular compartments (e.g., "nucleus", "cytoplasm", "mitochondria", "membrane", "secretome", "exosome")
      - Treatment: **ONLY experimental interventions applied to organisms/cells that ALTER biological state**:
        
        **CRITICAL FILTERING - READ CAREFULLY**:
        
        **INCLUDE ONLY** (these are actual treatments):
        * Drug/compound treatments: "MG-132", "TSA", "trichostatin A", "curcumin", "dexamethasone", "rapamycin", "PR-619"
        * Biological stimuli: "heat shock", "LPS stimulation", "hypoxia", "serum starvation", "poly(I:C) treatment", "glucose stimulation"
        * Physical interventions: "heat shock at 43°C", "cold treatment", "UV exposure"
        * Dietary interventions: "high-fat diet", "fasting", "glucose challenge" (these go to biological_info Treatment, not here)
        
        **EXCLUDE COMPLETELY** (these are NOT treatments):
        * Sample preparation: "saponin lysis", "protein extraction", "cell lysis", "centrifugation", "washing", "resuspension"
        * Enrichment/purification: "IMAC purification", "phosphopeptide enrichment", "TiO2 enrichment", "immunoaffinity purification"
        * Analytical procedures: "proteome profiling", "phosphorylation analysis", "phosphopeptide identification", "protein identification"
        * Bioinformatics: "Mascot Percolator scoring", "turbo-SLoMo scoring", "database searching", "peptide identification"
        * Mass spectrometry: "LC-MS/MS analysis", "MS analysis", "mass spectrometry", "tandem MS"
        * Other analytical methods: "flow cytometry", "PCR", "Western blot", "immunoblotting", "ELISA", "genotyping"
        * Sample processing: "snap frozen", "fixed", "embedded", "sectioning"
        * Administration routes: "intraperitoneal injection", "retro-orbital injection", "i.v.", "i.p.", "subcutaneous"
        * Localization analysis: "phosphorylation site localisation"
        
        **GOLDEN RULE**: If it's a METHOD for ANALYZING samples, it's NOT a treatment. Only extract compounds/stimuli APPLIED TO cells/organisms.
      
      - SampleTreatment: sample processing/preservation methods (e.g., "FFPE", "formalin-fixed paraffin-embedded", "snap frozen", "fresh frozen", "fixed in 4% paraformaldehyde")
      - Staining: histological staining methods (e.g., "Coomassie blue staining", "Coomassie", "H&E", "hematoxylin and eosin", "silver stain", "Ponceau S", "Ponceau-S")
      - GrowthRate: cell culture growth conditions (e.g., "exponential phase", "log phase", "OD600 = 0.6", "70% confluent")
      - SamplingTime: time point identifiers (e.g., "ZT6", "zeitgeber time 6", "day 1", "T0", "T24", "6 hours post-treatment")
      - BMI: body mass index values or ranges (e.g., "BMI 25-30", "BMI > 30", "average BMI 27.3")
      - AnatomicSiteTumor: anatomical location of tumor (e.g., "primary tumor", "left lung lobe", "colon", "breast")
      - OriginSiteDisease: origin site of disease (e.g., "primary site", "metastatic from lung")
      - TumorCellularity: tumor cell content percentage (e.g., "80% tumor cells", ">70% tumor cellularity", "high cellularity")
      - TumorGrade: histological tumor grade (e.g., "Grade 1", "Grade 2", "Grade 3", "well-differentiated", "poorly differentiated", "G1", "G2")
      - TumorStage: cancer staging information (e.g., "Stage I", "Stage IIB", "T3", "N1", "M0", "TNM staging", "pT2N0M0")
      - TumorSize: tumor dimensions (e.g., "2 cm", "5 cm diameter", "2.5 x 3 cm", "tumor size 15mm")
      - TumorSite: specific tumor location (e.g., "primary tumor site", "metastatic lesion", "lymph node metastasis")
      - FactorValue: experimental factors or conditions being compared in the study (e.g., "heat shock vs control", "MG-132 vs control", "PR-619 vs control", "wild-type vs knockout", "treated vs untreated", "disease vs healthy")
        
        **IMPORTANT**: Extract the comparison structure, not individual groups. Look for phrases like "compared to", "vs", "versus", "relative to"
      
      CRITICAL RULES FOR EXTRACTION:
      1. Convert ALL immunological cell markers to full cell type names during extraction (not after)
      2. **Filter OUT analytical methods from Treatment field** - this is CRITICAL
      3. Standardize cell lines: "HEK 293" → "HEK293", "MCF7"/"MCF-7" → "MCF-7"
      4. Standardize diseases: provide full name with abbreviation if commonly used
      5. For cell types, prefer specific names: "CD8+ T cells" over just "T cells", "regulatory T cells (Tregs)" over "Tregs"
      6. Extract information EXACTLY as written, but apply standardization rules immediately
      7. If you are uncertain whether information belongs to a category, do NOT include it
      8. If a category has no explicitly mentioned information, return an empty list for that category
      9. Do not make assumptions or inferences beyond what is directly stated
      10. **CellLine vs Strain**: Strain designations like "P. falciparum strain 3D7" go to Strain field, not CellLine
      
      Return your response as valid JSON using the category names above as keys, with lists of extracted strings as values. Do not include markdown formatting, code blocks, or any text outside the JSON structure. Return only the JSON object.
    
    gleaning:
      num_rounds: 2
      validation_prompt: |
        You are reviewing a clinical and experimental context metadata extraction to ensure completeness, accuracy, and proper standardization. Check if the extraction missed any of the following information based on study type:
        
        **CRITICAL TREATMENT FILTERING CHECK**:
        Review Treatment field - did it incorrectly include any of these analytical methods that should NOT be treatments?
        - Sample prep: "saponin lysis", "protein extraction", "cell lysis", "IMAC purification"
        - Bioinformatics: "Mascot Percolator scoring", "phosphorylation analysis", "proteome profiling"
        - MS methods: "phosphopeptide identification", "phosphorylation site localisation"
        - If any of these were extracted, flag them for removal
        
        FOR CLINICAL/PATIENT STUDIES:
        1. Disease information (CRITICAL)
           - Look for: disease names with full name + abbreviation format
           - Examples: "Alzheimer's disease (AD)", "colorectal cancer (CRC)", "type 2 diabetes (T2D)", "malaria"
           - Common mistakes: abbreviation only, or full name only
        
        2. Tumor characteristics (for cancer studies)
           - Stage: "Stage I", "Stage IIB", "T3N1M0"
           - Grade: "Grade 2", "well-differentiated", "G2"
           - Cellularity: "80% tumor cells", ">70% cellularity"
           - Size: "2 cm", "3.5 cm diameter"
           - Common mistakes: characteristics mentioned but not extracted
        
        3. Immunohistochemistry markers converted to cell types (CRITICAL)
           - Check: were markers like "CD8+", "CD4+", "CD20+", "FOXP3+" converted to cell type names?
           - Correct: "CD8+" → "CD8+ T cells", "FOXP3+" → "regulatory T cells (Tregs)"
           - Common mistakes: markers appear as-is without conversion
        
        FOR LABORATORY/EXPERIMENTAL STUDIES:
        1. Cell lines with standard formatting (CRITICAL)
           - Look for: "HeLa", "HEK293", "MCF-7", "A549", "U2-OS"
           - Standard format: no spaces, consistent hyphenation
           - Common mistakes: "HEK 293" instead of "HEK293"
           - **CellLine vs Strain**: "P. falciparum strain 3D7" should be in Strain, NOT CellLine
        
        2. Experimental treatments - MUST distinguish actual treatments from methods (CRITICAL)
           - CORRECT (actual treatments):
             * Drug treatments: "MG-132 treatment", "TSA", "rapamycin", "metformin", "PR-619"
             * Biological stimuli: "heat shock", "LPS stimulation", "poly(I:C)", "hypoxia"
             * Therapeutic agents: "anti-CD40 antibody treatment", "diphtheria toxin"
           
           - INCORRECT (should NOT be in Treatment field):
             * Sample prep: "saponin lysis", "protein extraction", "cell lysis"
             * Enrichment: "IMAC purification", "phosphopeptide enrichment", "TiO2 enrichment"
             * Analysis: "proteome profiling", "phosphorylation analysis", "phosphopeptide identification"
             * Bioinformatics: "Mascot Percolator scoring", "turbo-SLoMo scoring"
             * MS methods: "LC-MS/MS analysis", "mass spectrometry"
             * Administration: "intraperitoneal injection", "i.p."
             * Localization: "phosphorylation site localisation"
        
        3. FactorValue extraction (often missed):
           - Look for experimental comparisons: "heat shock vs control", "MG-132 vs control", "treated vs untreated"
           - Phrases: "compared to", "versus", "relative to", "vs"
           - Example: "We compared heat shock treated cells to control" → "heat shock vs control"
        
        4. Staining methods:
           - Look for: "Coomassie", "Coomassie blue", "Ponceau S", "Ponceau-S", "H&E"
           - Often in gel/blot descriptions
        
        Review the original text carefully and identify:
        - Any explicitly stated information that was missed in critical categories
        - Any ANALYTICAL METHODS incorrectly extracted as Treatment
        - Whether CellLine vs Strain distinction was properly maintained
        - Whether FactorValue comparisons were extracted
        - Whether the extraction appears complete for this paper
        
        Return a JSON object with:
        {
          "passes_validation": true or false,
          "critical_omissions": [list any specific missed information],
          "incorrect_treatments_extracted": [list any analytical methods incorrectly in Treatment field],
          "cellline_vs_strain_confusion": true or false (if strain in CellLine field),
          "missing_factor_values": true or false,
          "missing_staining": true or false,
          "next_round_instructions": "specific guidance on what to extract/fix in the next round"
        }

  - name: unnest_disease
    type: unnest
    unnest_key: Disease
    keep_empty: true

  - name: resolve_disease
    type: resolve
    blocking_keys:
      - Disease
    blocking_threshold: 0.80
    embedding_model: text-embedding-3-small
    embedding_threshold: 0.88
    comparison_prompt: |
      Are these the same disease?
      Disease 1: "{{ input1.Disease }}"
      Disease 2: "{{ input2.Disease }}"
      Return "True" if same, "False" if different.
    resolution_model: gpt-4o-mini
    resolution_prompt: |
      Standardize these disease names (prefer full name with common abbreviation):
      {% for entry in inputs %}{{ entry.Disease }}{% if not loop.last %}, {% endif %}{% endfor %}
      
      Examples: ["AD","Alzheimer's disease"]→"Alzheimer's disease (AD)", ["breast cancer","mammary carcinoma"]→"breast cancer", ["CRC","colorectal cancer"]→"colorectal cancer (CRC)"
      Return ONLY the canonical name.
    
    output:
      schema:
        canonical_disease: string

  - name: unnest_cell_line
    type: unnest
    unnest_key: CellLine
    keep_empty: true

  - name: resolve_cell_line
    type: resolve
    blocking_keys:
      - CellLine
    blocking_threshold: 0.80
    embedding_model: text-embedding-3-small
    embedding_threshold: 0.88
    comparison_prompt: |
      Are these the same cell line?
      Cell line 1: "{{ input1.CellLine }}"
      Cell line 2: "{{ input2.CellLine }}"
      Return "True" if same, "False" if different.
    resolution_model: gpt-4o-mini
    resolution_prompt: |
      Standardize these cell line names (consistent formatting):
      {% for entry in inputs %}{{ entry.CellLine }}{% if not loop.last %}, {% endif %}{% endfor %}
      
      Examples: ["HEK 293","HEK293"]→"HEK293", ["MCF7","MCF-7"]→"MCF-7", ["Hela","HeLa"]→"HeLa"
      Return ONLY the canonical name.
    
    output:
      schema:
        canonical_cell_line: string

  - name: unnest_cell_type
    type: unnest
    unnest_key: CellType
    keep_empty: true

  - name: resolve_cell_type
    type: resolve
    blocking_keys:
      - CellType
    blocking_threshold: 0.80
    embedding_model: text-embedding-3-small
    embedding_threshold: 0.88
    comparison_prompt: |
      Are these the same cell type?
      Cell type 1: "{{ input1.CellType }}"
      Cell type 2: "{{ input2.CellType }}"
      Return "True" if same, "False" if different.
    resolution_model: gpt-4o-mini
    resolution_prompt: |
      Standardize these cell type names (prefer full descriptive name with marker):
      {% for entry in inputs %}{{ entry.CellType }}{% if not loop.last %}, {% endif %}{% endfor %}
      
      Examples: ["CD8+ T cells","CD8 T cells","cytotoxic T cells"]→"CD8+ T cells", ["regulatory T cells","Tregs","FOXP3+ T cells"]→"regulatory T cells (Tregs)", ["B cells","CD19+ B cells","CD20+ B cells"]→"B cells", ["dendritic cells","DCs"]→"dendritic cells", ["erythrocytes","red blood cells"]→"erythrocytes"
      Return ONLY the canonical name.
    
    output:
      schema:
        canonical_cell_type: string

  - name: unnest_treatment
    type: unnest
    unnest_key: Treatment
    keep_empty: true

  - name: resolve_treatment
    type: resolve
    blocking_keys:
      - Treatment
    blocking_threshold: 0.85
    embedding_model: text-embedding-3-small
    embedding_threshold: 0.90
    comparison_prompt: |
      Are these the same treatment?
      Treatment 1: "{{ input1.Treatment }}"
      Treatment 2: "{{ input2.Treatment }}"
      Return "True" if same, "False" if different.
    resolution_model: gpt-4o-mini
    resolution_prompt: |
      Standardize these treatment names (prefer specific compound/stimulus with common abbreviation):
      {% for entry in inputs %}{{ entry.Treatment }}{% if not loop.last %}, {% endif %}{% endfor %}
      
      Examples: ["LPS","lipopolysaccharide","LPS stimulation"]→"lipopolysaccharide (LPS)", ["MG-132","MG132","proteasome inhibitor MG-132"]→"MG-132", ["TSA","trichostatin A"]→"trichostatin A (TSA)"
      Return ONLY the canonical name.
    
    output:
      schema:
        canonical_treatment: string

  - name: aggregate_clinical_data
    type: reduce
    reduce_key:
      - filename
    optimize: true
    model: gpt-4o
    output:
      schema:
        unique_diseases: list[string]
        unique_cell_lines: list[string]
        unique_cell_types: list[string]
        unique_treatments: list[string]
        unique_disease_treatments: list[string]
        unique_cell_parts: list[string]
        tumor_stages: list[string]
        tumor_grades: list[string]
        tumor_cellularity: list[string]
        tumor_sizes: list[string]
        tumor_sites: list[string]
        sample_treatments: list[string]
        staining_methods: list[string]
        growth_rates: list[string]
        sampling_times: list[string]
        bmi_values: list[string]
        factor_values: list[string]
    prompt: |
      Aggregate and deduplicate clinical/experimental data for: {{ reduce_key.filename }}
      
      {% for doc in inputs %}
      Diseases: {% if doc.canonical_disease %}{{ doc.canonical_disease }}{% elif doc.Disease %}{% for d in doc.Disease %}{{ d }}, {% endfor %}{% endif %}
      Cell lines: {% if doc.canonical_cell_line %}{{ doc.canonical_cell_line }}{% elif doc.CellLine %}{% for cl in doc.CellLine %}{{ cl }}, {% endfor %}{% endif %}
      Cell types: {% if doc.canonical_cell_type %}{{ doc.canonical_cell_type }}{% elif doc.CellType %}{% for ct in doc.CellType %}{{ ct }}, {% endfor %}{% endif %}
      Treatments: {% if doc.canonical_treatment %}{{ doc.canonical_treatment }}{% elif doc.Treatment %}{% for t in doc.Treatment %}{{ t }}, {% endfor %}{% endif %}
      Disease treatments: {% for dt in doc.DiseaseTreatment %}{{ dt }}, {% endfor %}
      Cell parts: {% for cp in doc.CellPart %}{{ cp }}, {% endfor %}
      Tumor stages: {% for s in doc.TumorStage %}{{ s }}, {% endfor %}
      Tumor grades: {% for g in doc.TumorGrade %}{{ g }}, {% endfor %}
      Tumor cellularity: {% for c in doc.TumorCellularity %}{{ c }}, {% endfor %}
      Tumor sizes: {% for ts in doc.TumorSize %}{{ ts }}, {% endfor %}
      Tumor sites: {% for site in doc.TumorSite %}{{ site }}, {% endfor %}
      Sample treatments: {% for st in doc.SampleTreatment %}{{ st }}, {% endfor %}
      Staining: {% for sm in doc.Staining %}{{ sm }}, {% endfor %}
      Growth rates: {% for gr in doc.GrowthRate %}{{ gr }}, {% endfor %}
      Sampling times: {% for stime in doc.SamplingTime %}{{ stime }}, {% endfor %}
      BMI: {% for bmi in doc.BMI %}{{ bmi }}, {% endfor %}
      Factor values: {% for fv in doc.FactorValue %}{{ fv }}, {% endfor %}
      {% endfor %}
      
      IMPORTANT FILTERING AND DEDUPLICATION RULES:
      1. REMOVE from treatments any analytical methods or procedures (CRITICAL):
         - Sample prep: "saponin lysis", "protein extraction", "cell lysis", "centrifugation", "washing"
         - Enrichment: "IMAC purification", "phosphopeptide enrichment", "TiO2 enrichment", "immunoaffinity purification"
         - Analysis methods: "proteome profiling", "phosphorylation analysis", "phosphopeptide identification", "phosphorylation site localisation"
         - Bioinformatics: "Mascot Percolator scoring", "turbo-SLoMo scoring", "database searching"
         - MS methods: "LC-MS/MS analysis", "mass spectrometry", "tandem MS"
         - Administration routes: "retro-orbital injection", "intraperitoneal injection", "i.v.", "i.p.", "subcutaneous injection"
         - Analytical methods: "flow cytometry", "FACS", "PCR", "qPCR", "RT-PCR", "genotyping", "western blot", "immunoblotting", "ELISA"
         - Sample preparation: "immunoprecipitation", "IP", "cell lysis", "centrifugation", "transfection" (as method), "washing steps"
         - Generic procedures: "adoptive transfer" (unless specific), "immunization" (unless specific agent), "injection" (unless specific compound)
      
      2. KEEP as treatments only actual biological interventions:
         - Drug treatments: "MG-132", "TSA", "rapamycin", "metformin", "dexamethasone", "PR-619", "curcumin"
         - Biological stimuli: "heat shock", "LPS stimulation", "poly(I:C)", "hypoxia", "serum starvation"
         - Therapeutic interventions: "diphtheria toxin administration", "anti-CD40 antibody treatment", "clodronate liposomes"
      
      3. DEDUPLICATE using canonical values when available:
         - Prefer canonical_disease, canonical_cell_line, canonical_cell_type, canonical_treatment
         - If canonical not available, deduplicate similar entries manually
      
      4. VERIFY cell markers were converted:
         - Should NOT see: "CD8+", "CD4+", "FOXP3+", "CD20+" as standalone entries
         - Should see: "CD8+ T cells", "CD4+ T cells", "regulatory T cells (Tregs)", "B cells"
      
      5. Standardize staining:
         - "Coomassie blue staining", "Coomassie stained" → "Coomassie"
         - "Ponceau-S", "Ponceau S" → "Ponceau-S"
      
      Return deduplicated JSON with unique values for all fields, properly filtered according to the rules above.

pipeline:
  steps:
    - name: clinical_experimental_pipeline
      input: papers
      operations:
        - extract_clinical_info
        - unnest_disease
        - resolve_disease
        - unnest_cell_line
        - resolve_cell_line
        - unnest_cell_type
        - resolve_cell_type
        - unnest_treatment
        - resolve_treatment
        - aggregate_clinical_data

  output:
    type: file
    path: ./output/clinical_experimental_complete.json
    intermediate_dir: ./checkpoints